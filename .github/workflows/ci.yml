name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install --save-dev eslint htmlhint stylelint
        
    - name: Create ESLint config
      run: |
        cat > .eslintrc.json << 'EOF'
        {
          "env": {
            "browser": true,
            "es2021": true
          },
          "extends": "eslint:recommended",
          "parserOptions": {
            "ecmaVersion": "latest",
            "sourceType": "module"
          },
          "rules": {
            "no-unused-vars": "warn",
            "no-console": "warn"
          }
        }
        EOF
        
    - name: Create HTMLHint config
      run: |
        cat > .htmlhintrc << 'EOF'
        {
          "tagname-lowercase": true,
          "attr-lowercase": true,
          "attr-value-double-quotes": true,
          "doctype-first": true,
          "tag-pair": true,
          "spec-char-escape": true,
          "id-unique": true,
          "src-not-empty": true,
          "attr-no-duplication": true,
          "title-require": true,
          "alt-require": true,
          "doctype-html5": true,
          "id-class-value": false,
          "style-disabled": false,
          "inline-style-disabled": false,
          "inline-script-disabled": false,
          "space-tab-mixed-disabled": true,
          "spec-char-escape": true,
          "id-unique": true,
          "src-not-empty": true
        }
        EOF
        
    - name: Create StyleLint config
      run: |
        cat > .stylelintrc.json << 'EOF'
        {
          "extends": "stylelint-config-standard",
          "rules": {
            "indentation": 2,
            "string-quotes": "single",
            "no-duplicate-selectors": true,
            "color-hex-case": "lower",
            "color-hex-length": "short",
            "selector-combinator-space-after": "always",
            "selector-attribute-quotes": "always",
            "selector-attribute-operator-space-before": "never",
            "selector-attribute-operator-space-after": "never",
            "selector-attribute-brackets-space-inside": "never"
          }
        }
        EOF
        
    - name: Run HTMLHint
      run: npx htmlhint **/*.html
      
    - name: Run ESLint
      run: npx eslint **/*.js
      
    - name: Run StyleLint
      run: npx stylelint **/*.css
      
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
